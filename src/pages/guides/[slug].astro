---
import GuideLayout from '@/layouts/GuideLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const guides = await getCollection('guides', ({ data }) => !data.draft);
  return guides.map((guide) => ({
    params: { slug: guide.slug },
    props: { guide },
  }));
}

const { guide } = Astro.props;
const { Content } = await guide.render();

const relatedProductSlugs = guide.data.relatedProducts ?? [];
const allProducts = relatedProductSlugs.length > 0
  ? await getCollection('products', ({ data }) => !data.draft)
  : [];
const recommendedProducts = relatedProductSlugs
  .map((s) => allProducts.find((p) => p.slug === s))
  .filter(Boolean)
  .map((p) => ({
    title: p.data.title,
    slug: p.slug,
    category: p.data.category,
    brand: p.data.brand,
    shortDescription: p.data.shortDescription,
    featuredImage: p.data.featuredImage,
    affiliateUrl: p.data.affiliateUrl,
  }));
---
<GuideLayout frontmatter={guide.data} slug={guide.slug} recommendedProducts={recommendedProducts}>
  <Content />
</GuideLayout>
